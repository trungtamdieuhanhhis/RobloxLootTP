-- ==========================================
-- MONITOR (Read-only) â€” Ghi log Equip + Handle props + Humanoid states
-- ==========================================
local filename = "MonitorLog.txt"
if not isfile(filename) then writefile(filename, "=== Monitor Log Start ===\n") end
local function save(s) appendfile(filename, s .. "\n") end

local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

save("Timestamp: "..tostring(os.time()))
save("Player: "..tostring(lp.Name))

local function dumpHandleInfo(handle)
    if not handle then
        save("Handle: nil")
        return
    end
    save("Handle.Name = "..tostring(handle.Name))
    save("Handle.ClassName = "..tostring(handle.ClassName))
    save("Handle.Size = "..tostring(handle.Size))
    save("Handle.Massless = "..tostring(handle.Massless))
    save("Handle.CanCollide = "..tostring(handle.CanCollide))
    -- attributes
    local attrs = {}
    for _,k in pairs(handle:GetAttributes()) do end -- ensure function exists
    for _,k in ipairs(handle:GetAttributes() or {}) do
        -- not all Runtimes expose GetAttributes as table; safe-guard
    end
    -- safer: iterate possible common attributes by name list
    local check = {"HitboxScaled","OriginSize","CustomId"}
    for _,k in ipairs(check) do
        local v = pcall(function() return handle:GetAttribute(k) end)
        if v then
            local val = handle:GetAttribute(k)
            save("Handle.Attribute."..k.." = "..tostring(val))
        end
    end
end

local function logHumanoidState(tag)
    save("---- "..tag.." ----")
    save("Time: "..tostring(os.time()))
    save("Humanoid.Health = "..tostring(hum.Health))
    save("Humanoid.WalkSpeed = "..tostring(hum.WalkSpeed))
    save("Humanoid.PlatformStand = "..tostring(hum.PlatformStand))
    save("Humanoid.Sit = "..tostring(hum.Sit))
    save("HRP.CFrame = "..tostring(hrp.CFrame.Position))
    save("MoveDirection = "..tostring(hum.MoveDirection))
end

-- Equip watcher
local function onEquipped(tool)
    save("EVENT: Equipped "..tostring(tool:GetFullName()))
    local h = tool:FindFirstChild("Handle")
    dumpHandleInfo(h)

    -- sample humanoid movement for short period to detect freeze
    logHumanoidState("Before sample")
    local t0 = tick()
    local moved = false
    local lastPos = hrp.Position
    while tick() - t0 < 3 do
        task.wait(0.25)
        local cur = hrp.Position
        if (cur - lastPos).Magnitude > 0.05 then moved = true end
        lastPos = cur
        logHumanoidState("Sample")
    end
    save("MovedDuring3s = "..tostring(moved))
    if not moved then
        save("ALERT: No movement detected during sample -> possible freeze")
    end
end

local function onUnequipped(tool)
    save("EVENT: Unequipped "..tostring(tool:GetFullName()))
end

-- Connect to all current and future tools in character
local function monitorCharacter(c)
    for _,v in ipairs(c:GetChildren()) do
        if v:IsA("Tool") then
            v.Equipped:Connect(function() pcall(onEquipped, v) end)
            v.Unequipped:Connect(function() pcall(onUnequipped, v) end)
        end
    end
    c.ChildAdded:Connect(function(ch)
        if ch:IsA("Tool") then
            ch.Equipped:Connect(function() pcall(onEquipped, ch) end)
            ch.Unequipped:Connect(function() pcall(onUnequipped, ch) end)
        end
    end)
end

monitorCharacter(char)
char.ChildAdded:Connect(function(c) 
    if c:IsA("Tool") then
        c.Equipped:Connect(function() pcall(onEquipped, c) end)
        c.Unequipped:Connect(function() pcall(onUnequipped, c) end)
    end
end)

-- also log humanoid changes passively
hum.Changed:Connect(function(prop)
    save("HumanoidChanged: "..tostring(prop).." = "..tostring(hum[prop]))
end)

save("Monitor ready. Run: equip weapon, wait 3s, then send MonitorLog.txt")
print("Monitor running. Log file:", filename)
